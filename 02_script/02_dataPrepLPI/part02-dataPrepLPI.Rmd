---
title: "Parte 02 - PREPARAÇÃO DE DADOS PARA CÁLCULO DE LPI"
output:
  pdf_document: default
  html_notebook: default
  word_document: default
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
---

Script de preparação de dados para cálculo do LPI baseado nas instruções
disponíveis [neste
link](https://github.com/Zoological-Society-of-London/rlpi).

**Em fase de TESTE**

Adaptação: Elildo Carvalho Jr, ICMBio/CENAP

Desenvolvimento: Fernando Lima, Algoritmo

## PREPARAÇÃO

### PACOTES

```{r pacotes, message=FALSE}
rm(list = ls(all = TRUE))
source("../funcoes/pacotes.R")
pacotes("here", "dplyr","tidyverse", "knitr")
```

### PREPARAÇÃO DE DADOS PARA CÁLCULO DE LPI

O arquivo `dadosICMBio_2014a2019.rds` deve ser gerado na etapa anterior
através de `part01-fixRawData.Rmd`

### Carregar arquivos

```{r}
mydata <- readRDS(
  here("03_dadosDeSaida/dados", "dadosICMBio_2014a2019.rds"))
```
\newpage
### Contagens

```{r}
#Contagem de UCs
ucs <- mydata %>%
  dplyr::group_by(
    cnuc,
    nome_UC
    )%>%
  dplyr::count()
#Contagem de espécies
sp <- mydata %>%
  dplyr::group_by(
    classe,
    ordem,
    familia,
    genero,
    binomial
    )%>%
  dplyr::count(
    )%>%
  dplyr::arrange(
    desc(n))
#Contagem de populações
population <- mydata %>%
  dplyr::group_by(
    nome_UC,
    populacao,
    cnuc
    )%>%
  dplyr::count(
    )%>%
  dplyr::arrange(
    desc(n)
    )%>%
  dplyr::filter()
```
\newpage
### Cálculo de esforço

```{r message=FALSE, paged.print=FALSE}
effort <- mydata %>%
#AGRUPAR POR UNIDADE DE CONSERVAÇÃO E ANO
  dplyr::group_by(
    cnuc,
    nome_UC,
    ano
    )%>%
#SOMAR ESFORÇO ANUAL POR UNIDADE DE CONSERVAÇÃO
  dplyr::summarize(
    sum(esforco,
        na.rm = TRUE)
    )%>%
#RENOMEAR COLUNA RESULTANTE
  dplyr::rename(
    effort = "sum(esforco, na.rm = TRUE)")
```

### Seleção por critérios

Selecionar UCs Seleção de UCs com mais de 1 ano de amostragem.

```{r}
ucs_selecionadas <- effort %>%
  dplyr::group_by(cnuc
           )%>% 
  dplyr::count(
    )%>%
  dplyr::filter(n > 1
                )%>%
  dplyr::pull(cnuc)
```

### Filtrar

Filtrar dados gerais mantendo somente UCs selecionadas

```{r}
mydata <- mydata %>%
  dplyr::filter(cnuc %in% ucs_selecionadas)
```
\newpage
## ESFORÇO ANUAL
### Esforço anual em km

```{r, message=FALSE}
esforco_anual <- mydata %>%
  dplyr::group_by(
    cnuc,
    ano
    )%>%
  dplyr::summarize(
    esforco = sum(
      esforco,
      na.rm = TRUE)
    )
#CÁLCULO PARA RELATÓRIO
esforcoAnualReport <- mydata %>%
  dplyr::group_by(
    cnuc,
    nome_UC,
    ano
    )%>%
  dplyr::summarize(
    esforco = sum(
      esforco,
      na.rm = TRUE)
    )
```

### Esforço anual em formato *wide*
```{r}
esforco_anual_wide <- esforco_anual %>%
  tidyr::pivot_wider(
    names_from = ano,
    values_from = esforco
    )%>%
  dplyr::select(
    cnuc,
    `2014`,
    `2015`,
    `2016`,
    `2017`,
    `2018`,
    `2019`,
    `2020`
    )%>%
  dplyr::ungroup()
#CÁLCULO PARA RELATÓRIO
esforcoAnualWideReport <- esforcoAnualReport %>%
  tidyr::pivot_wider(
    names_from = ano,
    values_from = esforco
    )%>%
  dplyr::select(
    cnuc,
    nome_UC,
    `2014`,
    `2015`,
    `2016`,
    `2017`,
    `2018`,
    `2019`,
    `2020`
    )%>%
  dplyr::ungroup(
  )%>%
  dplyr::rename(CNUC = "cnuc","Unidade de Conservação" = "nome_UC")
#GERAR TABELA
knitr::kable(esforcoAnualWideReport, caption = "Esforço anual das Unidades de Conservação")
```
\newpage
## NÚMERO DE REGISTROS
### Número de registros anuais

```{r}
n_registros <- mydata %>%
  dplyr::group_by(
    cnuc,
    ano,
    populacao
    )%>%
  dplyr::count()
#NÚMERO DE REGISTROS PARA O RELATÓRIO
nRegistrosReport <- mydata %>%
  dplyr::group_by(
    cnuc,
    nome_UC,
    ano,
    populacao
    )%>%
  dplyr::count()
```

### Número de registros anuais em formato *wide*

```{r}
n_registros_wide <- n_registros %>%
  tidyr::pivot_wider(
    names_from = ano,
    values_from = n
    )%>%
  dplyr::select(
    cnuc,
    populacao,
    `2014`,
    `2015`,
    `2016`,
    `2017`,
    `2018`,
    `2019`,
    `2020`
    )%>%
  replace(is.na(.), 0
          )%>%
  dplyr::ungroup()
#PARA RELATÓRIO
nRegistrosWideReport <- nRegistrosReport %>%
  tidyr::pivot_wider(
    names_from = ano,
    values_from = n
    )%>%
  dplyr::select(
    cnuc,
    nome_UC,
    populacao,
    `2014`,
    `2015`,
    `2016`,
    `2017`,
    `2018`,
    `2019`,
    `2020`
    )%>%
  replace(is.na(.), 0
          )%>%
  dplyr::ungroup(
    )%>%
  dplyr::rename(CNUC = "cnuc","Unidade de Conservação" = "nome_UC", "População" = "populacao")
#GERAR TABELA
#knitr::kable(nRegistrosWideReport , caption = "Número de registros anuais por população", align = "cllrrrrrrr")
```

```{r, results='asis'}
for (tabela in unique(nRegistrosWideReport$CNUC)) {
  print(
    knitr::kable(
      nRegistrosWideReport[nRegistrosWideReport$CNUC == tabela, ],
      caption = paste(
        "Número de registros anuais por população",
        "-",
        unique(nRegistrosWideReport$`Unidade de Conservação`[nRegistrosWideReport$CNUC == tabela]
               ),
        sep = " "),
      align = "cllrrrrrrr")
    )
}
```

\newpage
## TAXA DE ENCONTRO ANUAL

Estimativa de abundância relativa (número de registros por esforço).


Neste caso *NAs* devem ser mantidos.

```{r}
taxas_anuais <- data.frame(n_registros_wide)
esforcos_anuais <- data.frame(esforco_anual_wide)

for(i in 1:nrow(taxas_anuais)) {
  cnuc_temp <- taxas_anuais[i, "cnuc"]
  
  esforco_temp <- esforcos_anuais %>%
    dplyr::filter(
      cnuc == cnuc_temp
      )%>%
    dplyr::select(-cnuc)
  
  taxas_anuais[i, 3:9] <- round(taxas_anuais[i, 3:9]/esforco_temp, 3)
}

taxas_anuais <- as_tibble(taxas_anuais)
#taxas_anuais %>%  print(n=Inf)
```

### Seleção por critério
Selecionar populações com taxa de avistamento média acima de 0.1 (1
ind/10km)

```{r}
taxas_anuais <- taxas_anuais %>%
  dplyr::mutate(
    media = rowMeans(.[,3:9], na.rm = TRUE )
    )%>%
  dplyr::filter(media > 0.1
                )%>%
  dplyr::select(-media)

#GERAR TABELA
#knitr::kable(taxas_anuais, caption = "Taxas anuais por população")
```

```{r, results='asis'}
#PEGUE TAXAS ANUAIS PARA FAZER UMA TABELA
taxas_anuaisTable <- taxas_anuais
#RETIRE CNUC
#taxas_anuaisLonger <- taxas_anuaisTable[,-1]
#TRANSPÕE
#taxas_anuaisTable <-
 #   taxas_anuaisLonger %>%
  #  tidyr::pivot_longer(
   #   !populacao,
    #  names_to = "ano",
     # values_to = "index"
      #)
#PEGUE O CÓDIGO DA UC
#taxas_anuaisTable$cnuc <- substring(
 # taxas_anuaisTable$populacao,
  #nchar(taxas_anuaisTable$populacao)-2,
  #nchar(taxas_anuaisTable$populacao)
  #)
#RETIRE _
#taxas_anuaisTable$cnuc <- as.numeric(gsub("_","", taxas_anuaisTable$cnuc))
#PEGUE O NOME DAS UCs
taxas_anuaisTable <- merge(taxas_anuaisTable,ucs, by =  "cnuc")
#PEGUE O NOME DAS ESPÉCIES
taxas_anuaisTable$especie <- substr(
  taxas_anuaisTable$populacao,
  1,
  nchar(taxas_anuaisTable$populacao)-4
  )
#RETIRE _
taxas_anuaisTable$especie <- gsub("_"," ", taxas_anuaisTable$especie)
#RETIRE X DE ANO
#taxas_anuaisTable$ano <- as.factor(gsub("X","", taxas_anuaisTable$ano))

taxas_anuaisTable <- taxas_anuaisTable %>%
  dplyr::select(
    nome_UC,
    ano,
    especie,
    index
  )#%>%
  dplyr::rename(
    "Unidade de Conservação" = nome_UC,
    Ano = ano,
    "Espécie" = especie
  )

```

```{r, results='asis'}
for (tabela in unique(taxas_anuaisTable$`Unidade de Conservação`)) {
  print(
    knitr::kable( 
      taxas_anuaisTable[taxas_anuaisTable$`Unidade de Conservação` == tabela, ],
      caption = paste(
        "Número de registros anuais por população",
        "-",
        unique(taxas_anuaisTable$`Unidade de Conservação`[taxas_anuaisTable$`Unidade de Conservação` == tabela]
               ),
        sep = " "),
      align = "cllrrrrrrr")
    )
}

```


```{r}
for(UC in unique(taxas_anuaisTable$`Unidade de Conservação`)){
  temp <- taxas_anuaisTable[taxas_anuaisTable$`Unidade de Conservação` == UC,]

  print(ggplot(temp, aes(x = factor(Ano), y = index, group = 1)) +
  geom_line(
    lwd = 0.5,
    colour = "grey50"
    ) +#, lineend = "round") +
  
  geom_point() +
  
  #ylim(0, 5) +
  
  theme_bw() +
  
  theme(
    strip.background = element_rect(fill = "grey90"),
    
    strip.text.y = element_text(angle = 0, size = 9, color = "black"),# face = "bold"),
    
    axis.text.x = element_text(
      angle=45,
      vjust=1,
      hjust = 1,
      colour="black",
      size=rel(1)
      ),
    
    axis.text.y = element_text(
      angle=0,
      vjust=1,
      hjust = 1,
      colour="black",
      size=rel(1)
      ),
    
    axis.title.y = element_text(
      size = rel(1),
      margin = margin(
        t = 0,
        r = 10,
        b = 0,
        l = 0
        )
      ),
    
    axis.title.x = element_blank(),
      panel.spacing = unit(0.3, "lines")#,
    
    #pane
    
      ) +
  facet_grid(rows = vars(`Espécie`))+
  #facet_wrap(facets = vars(`Espécie`)) +

  ylab("LPI"))
  
}

```


```{r}

```{r}
#ADICIONAR NOMES DAS ESPÉCIES
taxas_anuais$sp <- substr(taxas_anuais$populacao,1,nchar(taxas_anuais$populacao)-4)
write.csv(taxas_anuais, here("03_dadosDeSaida/dados", "taxas_anuais.csv") )
```
