---
title: "Parte 02 - PREPARAÇÃO DE DADOS PARA CÁLCULO DE LPI"
output:
  pdf_document: default
  html_notebook: default
  word_document: default
  html_document:
    df_print: paged
---

Script de preparação de dados para cálculo do LPI baseado nas instruções disponíveis [neste link](https://github.com/Zoological-Society-of-London/rlpi).

**Em fase de TESTE**

Adaptação: Elildo Carvalho Jr, ICMBio/CENAP e Fernando Lima, Algoritmo

```{r pacotes, include=FALSE}
rm(list = ls(all = TRUE))
library(here)
library(tidyverse)
library(dplyr)
```

### PREPARAÇÃO DE DADOS PARA CÁLCULO DE LPI

Carregar dados. O arquivo `dadosICMBio_2014a2019.rds` deve ser gerado na etapa anterior através de `part01-fixRawData.Rmd`

```{r}
mydata <- readRDS(here("03_dadosDeSaida/dados", "dadosICMBio_2014a2019.rds"))
```

CONTAGENS:
- UCs
- Espécies
- Populações
```{r}
#Contagem de UCs
ucs <- mydata %>%
  group_by(nome_UC) %>%
  count()
#Contagem de espécies
sp <- mydata %>%
  group_by(classe, ordem, familia, genero, binomial) %>%
  count() %>%
  arrange(desc(n))
#Contagem de populações
population <- mydata %>%
  group_by(nome_UC, populacao, cnuc) %>%
  count() %>%
  arrange(desc(n)) %>%
  filter()
```

Cálculo de esforço

```{r, message=FALSE}
effort <- mydata %>%
#AGRUPAR PODE UNIDADE DE CONSERVAÇÃO E ANO
  group_by(cnuc, nome_UC, ano) %>%
#SOMAR ESFORÇO ANUAL POR UNIDADE DE CONSERVAÇÃO
  summarize(sum(esforco, na.rm = TRUE)) %>%
#RENOMEAR COLUNA RESULTANTE
  rename(effort = "sum(esforco, na.rm = TRUE)") #%>%
#FILTRAR PELO QUE SERIA O ESFORÇO MÍNIMO
  #filter(effort > 149)
```

### Seleção por critérios

Selecionar UCs Seleção de UCs com mais de 1 ano de amostragem e mais de 149 km de esforço anual.

```{r}
ucs_selecionadas <- effort %>%
  group_by(cnuc) %>% 
  count() %>%
  filter(n > 1) %>%
  pull(cnuc)
ucs_selecionadas
```

Filtrar

Filtrar dados gerais mantendo somente UCs selecionadas

```{r}
mydata <- mydata %>%
  filter(cnuc %in% ucs_selecionadas)
mydata
```

Esforço anual em km

```{r}
esforco_anual <- mydata %>%
  group_by(cnuc,nome_UC, ano) %>%
  summarize(esforco = sum(esforco, na.rm = TRUE))
```

Esforço anual em formato *wide* (QPEHE)

```{r}
esforco_anual_wide <- esforco_anual %>%
  pivot_wider(names_from = ano, values_from = esforco) %>%
  select(cnuc,
         nome_UC,
         `2014`,
         `2015`,
         `2016`,
         `2017`,
         `2018`,
         `2019`
         ) %>%
  ungroup()
```

```{r}

```


Número de registros anuais

```{r}
#NÚMERO DE REGISTROS ANÁLISE
n_registros <- mydata %>%
  group_by(cnuc, ano, populacao) %>%
  count() #%>%
 # mutate(n = as.numeric(n))
#NÚMERO DE REGISTROS PARA O RELATÓRIO
nRegistrosReport <- mydata %>%
  group_by(cnuc, nome_UC, ano, populacao) %>%
  count() #%>%
 # mutate(n = as.numeric(n))
```

Número de registros anuais em formato *wide*

```{r}
#PARA ANÁLISE
n_registros_wide <- n_registros %>%
  pivot_wider(names_from = ano, values_from = n) %>%
  select(cnuc,
         populacao,
         `2014`,
         `2015`,
         `2016`,
         `2017`,
         `2018`,
         `2019`
         ) %>%
  replace(is.na(.), 0) %>%
  ungroup()
n_registros_wide
#PARA RELATÓRIO
nRegistrosWideReport <- nRegistrosReport %>%
  pivot_wider(names_from = ano, values_from = n) %>%
  select(cnuc,
         nome_UC,
         populacao,
         `2014`,
         `2015`,
         `2016`,
         `2017`,
         `2018`,
         `2019`
         ) %>%
  replace(is.na(.), 0) %>%
  ungroup()
#n_registros_report

```

### Taxa de encontro anual

Estimativa de abundância relativa (número de registros por esforço). Neste caso *NAs* devem ser mantidos.

```{r}
taxas_anuais <- data.frame(n_registros_wide)
esforcos_anuais <- data.frame(esforco_anual_wide)
for(i in 1:nrow(taxas_anuais)) {
  cnuc_temp <- taxas_anuais[i, "cnuc"]
  esforco_temp <- esforcos_anuais %>% filter(cnuc == cnuc_temp) %>% select(-cnuc)
  taxas_anuais[i, 3:8] <- round(taxas_anuais[i, 3:8]/esforco_temp, 3)
}
taxas_anuais <- as_tibble(taxas_anuais)
taxas_anuais %>%
  print(n=Inf)
```

Selecionar populações com taxa de avistamento média acima de 0.1 (1 ind/10km)

```{r}
taxas_anuais <- taxas_anuais %>%
  mutate(media = rowMeans(.[,3:8])) %>%
  filter(media > 0.1) %>%
  select(-media)

print(taxas_anuais, n=Inf)
```

```{r}
names(ucs)
merge(taxas_anuais,ucs, by = )
```


Exportar arquivo para próxima etapa

```{r}
write.csv(taxas_anuais, here("03_dadosDeSaida/dados", "taxas_anuais.csv") )
```