---
title: "Parte 03 - CÁLCULO DE LPI"
output:
  pdf_document: default
  html_notebook: default
  word_document: default
  html_document:
    df_print: paged
---

Script para cálculo do LPI baseado nas instruções disponíveis [neste link](https://github.com/Zoological-Society-of-London/rlpi).

**Em fase de TESTE**

Adaptação: Elildo Carvalho Jr, ICMBio/CENAP e Fernando Lima, Algoritmo

```{r pacotes, include=FALSE}
rm(list = ls(all = TRUE))
library(tidyverse)
```

Funções do pacote `Rlpi`. O pacote apresenta várias limitações e por isso adotamos o uso das funções.
```{r}
source("../../02_script/funcoes/LPIMain.R")
source("../../02_script/funcoes/create_infile.R")
source("../../02_script/funcoes/CalcLPI.R")
source("../../02_script/funcoes/ProcessFile.R")
source("../../02_script/funcoes/debug_print.R")
source("../../02_script/funcoes/calculate_index.R")
source("../../02_script/funcoes/bootstrap_lpi.R")
source("../../02_script/funcoes/plot_lpi.R")
source("../../02_script/funcoes/ggplot_lpi_modif.R")
```

### CÁLCULO DE LPI

Carregar dados. O arquivo `taxas_anuais.csv` deve ser gerado na etapa anterior através de `part02-dataPrepLPI.Rmd`

```{r}
taxas_anuais <- read.csv("../../03_dadosDeSaida/dados/taxas_anuais.csv")
```

Adicionar campo identificador `ID`

```{r}
mydata_lpi <- taxas_anuais %>%
  mutate(ID = as.numeric(1:nrow(taxas_anuais))) %>%
  rename(Binomial = populacao) %>%
  select(cnuc, ID, Binomial, X2014, X2015, X2016, X2017, X2018, X2019)
```

Ajustes e criação de objetos necessários para o cálculo de LPI
```{r}
# criar objetos que necessarios para lpi
index_vector = rep(TRUE, nrow(mydata_lpi))
year_vector <- 2014:2019

```

```{r}
# criar infile
mydata_infile <- create_infile(mydata_lpi, index_vector=index_vector, 
                               #name=here("lpi", "mydata_data"),
                               name = "Infile",
                               start_col_name = colnames(mydata_lpi)[4], end_col_name = tail(colnames(mydata_lpi), n=1),
                               CUT_OFF_YEAR = year_vector[1])
```

Cálculo geral de LPI (para todas as UCs)
```{r}
# Calcular LPI com 100 bootstraps
#source(here("bin", "LPIMain.R")) # adicionado por não ter pacote rlpi
mydata_lpi <- LPIMain(#infile = here("lpi", "mydata_data_infile.txt"),
                      infile = "Infile_infile.txt",
                      #basedir = here("lpi"),
                      REF_YEAR = year_vector[1],
                      PLOT_MAX = tail(year_vector, n=1),
                      BOOT_STRAP_SIZE = 100) #, VERBOSE=FALSE)

```


```{r}
# Remover NAs (anos seguidos sem dados)
mydata_lpi <- mydata_lpi[complete.cases(mydata_lpi), ]
```

```{r}
# Gerar gráfico mais bonito usando função ggplot_lpi_modif
ggplot_lpi_modif(mydata_lpi, col="darkcyan")
ggsave(file = here("03_dadosDeSaida/plots", "lpiGlobal.png"))

ggplot(mydata_lpi, aes(x = 1:nrow(mydata_lpi), y = LPI_final, group = 1)) +
  #Intervalo de confiança
  geom_ribbon(
    aes(ymin = CI_low, ymax = CI_high),
    fill = "mediumaquamarine",
    alpha = 0.9,
    colour = "grey50"
    ) +
  
  geom_line(
    lwd = 0.5,
    colour = "grey50"
    ) +#, lineend = "round") +
  
  geom_point() +
  
  ylim(0,2) +
  
  theme_bw() +
  
  theme(
    strip.background = element_rect(fill = "grey90"),
    strip.text.y = element_text(angle = 0, size = 10, color = "black", face = "bold"),
    axis.text.x = element_text(
      angle=45,
      vjust=1,
      hjust = 1,
      colour="black",
      size=rel(1.3)
      ),
    axis.text.y = element_text(
      angle=0,
      vjust=1,
      hjust = 1,
      colour="black",
      size=rel(1.3)
      ),
    axis.title.y = element_text(
      size = rel(1.3),
      margin = margin(
        t = 0,
        r = 10,
        b = 0,
        l = 0
        )
      ),
    axis.title.x = element_blank(),
      panel.spacing = unit(0.8, "lines"),
      ) +

  #facet_grid(rows = vars(uc)) +

  ylab("LPI")


```