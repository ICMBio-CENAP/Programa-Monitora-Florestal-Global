---
title: "Part 02 Calculate LPI"
output:
  html_document:
    df_print: paged
  html_notebook: default
  word_document: default
---

Script para cálculo do LPI baseado nas instruções disponíveis [neste link](https://github.com/Zoological-Society-of-London/rlpi).

Função prepara dados do icmbio e chama funções do pacote rlpi

**Em fase de TESTE**

Adaptação: Elildo Carvalho Jr, ICMBio/CENAP.

Colaboração: Fernando Lima

### Carregar pacotes

```{r pacotes}
library(here)
library(tidyverse)
library(dplyr)
```

### Carregar funções

```{r}
source(here("bin", "lpi_icmbio.R"))
```

### Carregar dados

```{r}
#Versão disponível:
#dadosICMBio <- readRDS(here("data", "dadosICMBio_2014a2018.rds"))
#Versão não disponível
dadosICMBio <- readRDS(here("data", "dadosICMBio_2014a2019.rds"))
mydata <- dadosICMBio
```

### Contagem de UCs
```{r}
mydata %>%
  group_by(nome_UC) %>%
  count()
```

### Contagem de espécies
```{r}
mydata %>%
  group_by(binomial) %>%
  count() %>%
  arrange(desc(n)) %>%
  filter(! binomial  %in% c(
    NA,
    "E",
    "Tinamidae",
    "Cracidae",
    "Sciuridae",
    "Callitrichidae",
    "Pitheciidae",
    "Atelidae",
    "Cebidae",
    "Primates",
    "Felidae",
    "Bradypodidae",
    "Cervidae"
    )
    ) %>%
  filter(! grepl('sp.', binomial)) %>%
  print(n=Inf)
```

### Contagem de populações
```{r}
mydata %>%
  filter(! binomial  %in% c(
    NA,
    "E",
    "Tinamidae",
    "Cracidae",
    "Sciuridae",
    "Callitrichidae",
    "Pitheciidae",
    "Atelidae",
    "Cebidae",
    "Primates",
    "Felidae",
    "Bradypodidae",
    "Cervidae"
    )
    ) %>%
  group_by(populacao) %>%
  count() %>%
  arrange(desc(n)) %>%
  filter(! grepl('sp.', populacao)) %>%
  filter() %>%
  print(n=Inf)
```

### Contagem de transectos
```{r}
mydata %>%
  distinct(nome_UC, estacao_amostral) %>%
  count()
```

### Esforço total
```{r}
mydata %>%
  summarize(sum(esforco, na.rm = TRUE)/1000)
```

### Cálculo de esforço anual por UC (Km)
```{r}
esforco <- mydata %>%
  group_by(cnuc, ano) %>%
  summarize(esforco = sum(esforco, na.rm = TRUE)/1000) %>%
  filter(esforco > 149) 
esforco
```

##Seleção por critérios
### Selecionar UCs
Seleção de UCs com mais de 1 ano de amostragem e mais de 149 km de esforço anual.
```{r}
ucs_selecionadas <- esforco %>%
  group_by(cnuc) %>% 
  count() %>%
  filter(n > 1) %>%
  pull(cnuc)
ucs_selecionadas
```

### Filtrar
Filtrar dados mantendo somente UCs selecionadas
```{r}
mydata <- mydata %>%
  filter(cnuc %in% ucs_selecionadas)
mydata
```

Remover especies identificadas apenas ao nível de gênero
```{r}
mydata <- mydata %>%
  filter(! grepl('sp.', binomial))
mydata
```

Esforço anual em km
```{r}
esforco_anual <- mydata %>%
  group_by(cnuc, ano) %>%
  summarize(esforco = sum(esforco, na.rm = TRUE)) %>%
  mutate(esforco = esforco/1000)
esforco_anual
```

Esforço anual em formato *wide* (QPEHE)
```{r}
esforco_anual_wide <- esforco_anual %>%
  pivot_wider(names_from = ano, values_from = esforco) %>%
  select(cnuc,
         `2014`,
         `2015`,
         `2016`,
         `2017`,
         `2018`,
         `2019`
         ) %>%
  ungroup()
esforco_anual_wide
```

Número de registros anuais
```{r}
n_registros <- mydata %>%
  group_by(cnuc, ano, populacao) %>%
  count() %>%
  mutate(n = as.numeric(n))
n_registros
```

Número de registros anuais em formato *wide* (QPEHE)
```{r}
n_registros_wide <- n_registros %>%
  pivot_wider(names_from = ano, values_from = n) %>%
  select(cnuc,
         populacao,
         `2014`,
         `2015`,
         `2016`,
         `2017`,
         `2018`,
         `2019`
         ) %>%
  replace(is.na(.), 0) %>%
  ungroup()
n_registros_wide
```

### Taxa de encontro anual
Estimativa de abundância relativa (número de registros por esforço).
Neste caso *NAs* devem ser mantidos! Vai entender...
```{r}
taxas_anuais <- data.frame(n_registros_wide)
esforcos_anuais <- data.frame(esforco_anual_wide)
for(i in 1:nrow(taxas_anuais)) {
  cnuc_temp <- taxas_anuais[i, "cnuc"]
  esforco_temp <- esforcos_anuais %>% filter(cnuc == cnuc_temp) %>% select(-cnuc)
  taxas_anuais[i, 3:8] <- round(taxas_anuais[i, 3:8]/esforco_temp, 3)
}
taxas_anuais <- as_tibble(taxas_anuais)
taxas_anuais %>%
  print(n=Inf)
```

Selecionar populações com taxa de avistamento média acima de 0.1 (1 ind/10km)
```{r}
taxas_anuais <- taxas_anuais %>%
  mutate(media = rowMeans(.[,3:8])) %>%
  filter(media > 0.1) %>%
  select(-media)
taxas_anuais
#print(taxas_anuais, n=Inf)
```
